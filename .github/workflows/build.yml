name: Build

on: [push]

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - kind: linux
            os: ubuntu-latest
            platform: linux
          - kind: windows
            os: windows-latest
            platform: win
          - kind: flatpak
            os: ubuntu-latest
            platform: flatpak
          # Macos-11 is deprecated, macos-12 would require package updates, see PR #1409
          # - kind: mac
          #   os: macos-11
          #   platform: osx
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install: true
          cache: true
          log_level: debug

      - name: Install Yarn dependencies
        run: yarn install --immutable

      - if: matrix.platform == 'linux' || matrix.platform == 'flatpak'
        name: Install bsdtar # Required by electron-builder when targeting pacman.
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libarchive-tools

      - if: matrix.platform == 'flatpak'
        name: Cache Flatpak runtimes
        uses: actions/cache@v4
        with:
          path: ~/.local/share/flatpak
          key: flatpak-${{ runner.os }}-25.08

      - if: matrix.platform == 'flatpak'
        name: Install Flatpak and flatpak-builder
        run: |
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//25.08 org.freedesktop.Sdk//25.08
          flatpak install --user -y flathub org.electronjs.Electron2.BaseApp//25.08

      - name: Build project
        id: build
        uses: StarUbiquitous/command-output@v1.0.1 # Store stdout/stderr to outputs.
        # You might want to turn this on if there's problems with electron-builder.
        # env:
        #   DEBUG: electron-builder
        with:
          run: yarn build-${{ matrix.platform }} --publish=never

      - if: steps.build.outputs.stderr != ''
        name: Log stderr
        continue-on-error: true
        run: echo '${{ steps.build.outputs.stderr }}'

      # Creating Electron executables can in some cases fail with exit code 0.
      # Check the output of build step for obvious signs of failure.
      - if: contains(steps.build.outputs.stderr, '[FAIL]')
        name: Check STDERR for trouble
        uses: actions/github-script@v6
        with:
          script: core.setFailed('It seems the build process failed silently. See previous step for more info.')

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          path: 'dist/electron/Packaged'
          name: 'r2modman-${{ matrix.platform }}-build-${{ github.sha }}'
